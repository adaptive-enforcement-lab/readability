repos:
  - repo: local
    hooks:
      - id: readability
        name: Check documentation readability
        entry: go run ./cmd/readability --check --format diagnostic docs/
        language: system
        files: '^docs/.*\.md$'
        pass_filenames: false

      - id: go-test
        name: Run Go tests
        entry: bash -c 'go test -race ./...'
        language: system
        files: '\.go$'
        pass_filenames: false

      - id: go-coverage
        name: Check test coverage threshold
        entry: >
          bash -c '
          go test -coverprofile=/tmp/coverage.out ./... &&
          COVERAGE=$(go tool cover -func=/tmp/coverage.out | grep total | awk "{print \$3}" | sed "s/%//") &&
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below 80%"; exit 1;
          fi;
          echo "Coverage: ${COVERAGE}%"
          '
        language: system
        files: '\.go$'
        pass_filenames: false
        stages: [pre-push]
