repos:
  - repo: local
    hooks:
      - id: gofmt
        name: Format Go code (gofmt -s)
        entry: bash -c 'gofmt -s -l -d "$@" | head -20; test -z "$(gofmt -s -l "$@")"' --
        language: system
        files: '\.go$'
        pass_filenames: true

      - id: go-vet
        name: Run go vet
        entry: go vet ./...
        language: system
        files: '\.go$'
        pass_filenames: false

      - id: golangci-lint
        name: Run golangci-lint
        entry: golangci-lint run --fix
        language: system
        files: '\.go$'
        pass_filenames: false

      - id: gocyclo
        name: Check cyclomatic complexity
        entry: >
          bash -c '
          command -v gocyclo >/dev/null || go install github.com/fzipp/gocyclo/cmd/gocyclo@latest;
          $(go env GOPATH)/bin/gocyclo -over 15 .
          '
        language: system
        files: '\.go$'
        pass_filenames: false

      - id: go-test
        name: Run Go tests
        entry: bash -c 'go test -race ./...'
        language: system
        files: '\.go$'
        pass_filenames: false

      - id: go-coverage
        name: Check test coverage threshold
        entry: >
          bash -c '
          THRESHOLD=$(grep -A2 "project:" codecov.yml | grep "target:" | head -1 | sed "s/.*target: *\([0-9]*\).*/\1/") || THRESHOLD=95;
          go test -coverprofile=/tmp/coverage.out ./... &&
          COVERAGE=$(go tool cover -func=/tmp/coverage.out | grep total | awk "{print \$3}" | sed "s/%//") &&
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below ${THRESHOLD}%"; exit 1;
          fi;
          echo "Coverage: ${COVERAGE}% (threshold: ${THRESHOLD}%)"
          '
        language: system
        files: '\.go$'
        pass_filenames: false
        stages: [pre-push]

      - id: readability
        name: Check documentation readability
        entry: go run ./cmd/readability --check --format diagnostic docs/
        language: system
        files: '^docs/.*\.md$'
        pass_filenames: false
