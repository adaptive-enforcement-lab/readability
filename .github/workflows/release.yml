name: Release Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_release_please:
        description: "Skip release-please (use for manual rebuilds)"
        type: boolean
        default: false
      force_docs:
        description: "Force docs rebuild"
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_release_please }}
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Output release info
        run: |
          echo "## Release Please" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release Created | ${{ steps.release.outputs.release_created || 'false' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Version | ${{ steps.release.outputs.version || '-' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tag | ${{ steps.release.outputs.tag_name || '-' }} |" >> "$GITHUB_STEP_SUMMARY"

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    needs: release-please
    if: always() && !cancelled()
    outputs:
      docs_changed: ${{ steps.changes.outputs.docs_any_changed }}
      go_changed: ${{ steps.changes.outputs.go_any_changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            docs:
              - docs/**
              - mkdocs.yml
            go:
              - '**.go'
              - go.mod
              - go.sum

  build-go:
    name: Build Go Binaries
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            EXT=".exe"
          fi
          go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o readability_${{ matrix.goos }}_${{ matrix.goarch }}${EXT} \
            ./cmd/readability

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: readability_${{ matrix.goos }}_${{ matrix.goarch }}
          path: readability_*

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [release-please, build-go]
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Create archives
        run: |
          cd dist
          for file in readability_*; do
            if [[ "$file" == *.exe ]]; then
              base="${file%.exe}"
              zip "${base}.zip" "$file"
            else
              tar -czvf "${file}.tar.gz" "$file"
            fi
          done
          sha256sum *.tar.gz *.zip > checksums.txt

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd dist
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            *.tar.gz *.zip checksums.txt \
            --repo ${{ github.repository }}

  build-docs:
    name: Build Documentation
    needs: [release-please, detect-changes]
    if: |
      always() && !cancelled() &&
      (needs.detect-changes.outputs.docs_changed == 'true' || inputs.force_docs == true || needs.release-please.outputs.release_created == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version alias
        id: version
        run: |
          if [ "${{ needs.release-please.outputs.release_created }}" == "true" ]; then
            VERSION="${{ needs.release-please.outputs.version }}"
            MAJOR="${{ needs.release-please.outputs.major }}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "alias=v${MAJOR}" >> "$GITHUB_OUTPUT"
            echo "update_latest=true" >> "$GITHUB_OUTPUT"
          else
            echo "version=dev" >> "$GITHUB_OUTPUT"
            echo "alias=" >> "$GITHUB_OUTPUT"
            echo "update_latest=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy versioned docs
        if: needs.release-please.outputs.release_created == 'true'
        run: |
          mike deploy --push --update-aliases \
            ${{ steps.version.outputs.version }} \
            ${{ steps.version.outputs.alias }} latest

      - name: Deploy dev docs
        if: needs.release-please.outputs.release_created != 'true'
        run: |
          mike deploy --push dev

  update-tags:
    name: Update Tag Aliases
    runs-on: ubuntu-latest
    needs: [release-please, upload-release-assets]
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update floating version tags
        run: |
          MAJOR="${{ needs.release-please.outputs.major }}"
          TAG_NAME="${{ needs.release-please.outputs.tag_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update major version tag (e.g., 0 -> 0.6.0)
          git tag -fa "${MAJOR}" "${TAG_NAME}" -m "Alias for ${TAG_NAME}"
          git push origin "${MAJOR}" --force

          # Update 'latest' tag
          git tag -fa "latest" "${TAG_NAME}" -m "Alias for ${TAG_NAME}"
          git push origin "latest" --force

          echo "## Tag Aliases Updated" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Alias | Points To |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-----------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| ${MAJOR} | ${TAG_NAME} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| latest | ${TAG_NAME} |" >> "$GITHUB_STEP_SUMMARY"

  release-status:
    name: Release Status
    runs-on: ubuntu-latest
    needs: [release-please, detect-changes, build-go, upload-release-assets, build-docs, update-tags]
    if: always()
    steps:
      - name: Check release results
        run: |
          echo "## Release Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release Please | ${{ needs.release-please.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build Go | ${{ needs.build-go.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Upload Assets | ${{ needs.upload-release-assets.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build Docs | ${{ needs.build-docs.result || 'skipped' }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Fail if any required job failed
        if: |
          needs.build-go.result == 'failure' ||
          needs.upload-release-assets.result == 'failure' ||
          needs.build-docs.result == 'failure'
        run: exit 1
